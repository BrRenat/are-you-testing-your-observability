import { Head, Image, Appear, Notes, Invert, Split } from "mdx-deck"

import { CodeSurfer, CodeSurferColumns, Step } from "code-surfer"
import { github, oceanicNext } from "@code-surfer/themes"

import thanos from './static/thanos_logo.svg'
import prometheus from './static/prometheus_logo.svg'
import redhat from './static/red_hat_logo.png'

export const theme = github;

<Head>
	<title>Are you testing your Observability?</title>
</Head>

<Invert>

# Are you testing your Observability?
### GoDays 2020, Berlin
#### 22.01.2020

</Invert>

<Notes>

Introduction

</Notes>

---

<Image src={prometheus} size='contain'/>

<Notes>
Who are we?
Bartek Prometheus maintainer
</Notes>

---

<Image src={thanos} size='90%'/>

<Notes>
Bartek Thanos creator and maintainer
Kemal Thanos contributor
</Notes>

---

<Image src={redhat} size='auto'/>

<Notes>

We work for Red Hat.
We are building scalable Observability solutions and platforms for OpenShift.
We work with Prometheus and Thanos on a daily basis.

</Notes>

---

<Invert>

<img src="https://raw.githubusercontent.com/kakkoyun/are-you-testing-your-observability/master/static/ss_01.png" style="height: 90%"/>

</Invert>

<Notes>

This is Kemal's first talk.
That's why we worked very hard... (sarcasm)

</Notes>

---

# What is observability?

<Notes>

* Pillars of Observability
	* Metrics, Logging, Tracing
	* Aggregatable, Discrete Events, Request-scoped
* Proactive, Reactive
* Value of Observability

</Notes>

---

<Split>

<Image src={prometheus} size='auto'/>

# Why Prometheus?

</Split>

<Notes>
	Because Prometheus is
</Notes>

---

# Signals

<Notes>
# Why Prometheus?
</Notes>

---

# Metrics are essential

<Notes>Create speaker notes with the Notes component</Notes>

---

# Prometheus - How to expose?

<Notes>Create speaker notes with the Notes component</Notes>

---

# Holy battle; pull vs push

<Notes>Create speaker notes with the Notes component</Notes>

---

# Instrumenting Go applications

<Notes>Create speaker notes with the Notes component</Notes>

---

# Common pitfalls

<Notes>Create speaker notes with the Notes component</Notes>

---

# Globals

<Notes>Create speaker notes with the Notes component</Notes>

---

# Intro: define metric; register; expose HTTP; usage

---

<CodeSurfer theme={oceanicNext}>

```go title="Collectors are your frinends"
    // Register standard Go metric collectors, which are by default registered when using global registry.
	reg.MustRegister(
		version.NewCollector("observable-demo"),
	)
```

```go title="Collectors are your frinends"
    // Register standard Go metric collectors, which are by default registered when using global registry.
	reg.MustRegister(
		version.NewCollector("observable-demo"),
		prometheus.NewBuildInfoCollector(),
	)
```

```go title="Collectors are your frinends"
    // Register standard Go metric collectors, which are by default registered when using global registry.
	reg.MustRegister(
		version.NewCollector("observable-demo"),
		prometheus.NewBuildInfoCollector(),
		prometheus.NewGoCollector(),
	)
```

```go title="Collectors are your frinends"
    // Register standard Go metric collectors, which are by default registered when using global registry.
	reg.MustRegister(
		version.NewCollector("observable-demo"),
		prometheus.NewBuildInfoCollector(),
		prometheus.NewGoCollector(),
		prometheus.NewProcessCollector(prometheus.ProcessCollectorOpts{}),
	)
```

</CodeSurfer>

<Notes>Create speaker notes with the Notes component</Notes>

---

<CodeSurfer theme={oceanicNext}>

```go title="Functions"
    // Register standard Go metric collectors, which are by default registered when using global registry.
	reg.MustRegister(
		version.NewCollector("observable-demo"),
		prometheus.NewGaugeFunc(prometheus.GaugeOpts{
			Name: "configured_failed_target_backoff_duration_seconds",
			Help: "Configured backoff time for unavailable target.",
		}, func() float64 { return blacklistBackoff.Seconds() }), // nolint: gocritic
	)
```

</CodeSurfer>

<Notes>Create speaker notes with the Notes component</Notes>

---

<CodeSurfer theme={oceanicNext}>

```go title="Register Handler"
    mux.Handle("/metrics", promhttp.HandlerFor(reg, promhttp.HandlerOpts{}))
```

```diff 1 subtitle="expose metrics"

```

</CodeSurfer>

<Notes>Create speaker notes with the Notes component</Notes>

---

# Problems: terrible for libs

<Notes>Create speaker notes with the Notes component</Notes>

---

# Solution: custom registered

<Notes>Create speaker notes with the Notes component</Notes>

---

# Counter vs Gauges

<Notes>Create speaker notes with the Notes component</Notes>

---

# Problems ??

<Notes>Create speaker notes with the Notes component</Notes>

---

# Queue size vs added/removed?

<Notes>Create speaker notes with the Notes component</Notes>

---

# Gauge, reset etc loss of info

<Notes>Create speaker notes with the Notes component</Notes>

---

# Histogram vs Summaries

<Notes>Create speaker notes with the Notes component</Notes>

---

# Yolo histogram buckets

<Notes>Create speaker notes with the Notes component</Notes>

---

# Not SLO based

<Notes>Create speaker notes with the Notes component</Notes>

---

# Random string in labels

<Notes>Create speaker notes with the Notes component</Notes>

---

# No Testing

<Notes>Create speaker notes with the Notes component</Notes>

---

# Hardcoding namespace in libraries/package

<Notes>Create speaker notes with the Notes component</Notes>

---

# WrapRegisterer

<CodeSurfer theme={oceanicNext}>

```go
// WrapRegistererWithPrefix is like prometheus.WrapRegistererWithPrefix but it passes nil straight through
// which allows nil check.
func WrapRegistererWithPrefix(prefix string, reg prometheus.Registerer) prometheus.Registerer {
	if reg == nil {
		return nil
	}

	return prometheus.WrapRegistererWithPrefix(prefix, reg)
}
```
</CodeSurfer>

<CodeSurfer theme={oceanicNext}>

```go
// WrapRegistererWith is like prometheus.WrapRegistererWith but it passes nil straight through
// which allows nil check.
func WrapRegistererWith(labels prometheus.Labels, reg prometheus.Registerer) prometheus.Registerer {
	if reg == nil {
		return nil
	}

	return prometheus.WrapRegistererWith(labels, reg)
}
```
</CodeSurfer>

<Notes>Create speaker notes with the Notes component</Notes>

---

# Not using middlewares

<Notes>Create speaker notes with the Notes component</Notes>

---

# Solution:

<Notes>Create speaker notes with the Notes component</Notes>

---

# Reuse internally

<Notes>Create speaker notes with the Notes component</Notes>

---

# Convention/reuse dashboards; monitoring-mixins!

<Notes>Create speaker notes with the Notes component</Notes>

---

# extra: Promtool and alert testing!

<Notes>Create speaker notes with the Notes component</Notes>

---

# ~~Q/A~~
# Discussion

<Notes>Create speaker notes with the Notes component</Notes>

---


<Split>

<span>

![](https://avatars3.githubusercontent.com/u/6950331?s=360)

### Bartek Plotka
	twitter.com/bwplotka
	github.com/bwplotka

</span>

<div>


![](https://avatars0.githubusercontent.com/u/536449?s=360)

### Kemal Akkoyun
	twitter.com/kkakkoyun
	github.com/kkakkoyun

</div>

</Split>

---

# Thank you!

<img src="https://raw.githubusercontent.com/kakkoyun/are-you-testing-your-observability/master/static/red_hat_logo.png" style="height: 20%"/>

---

Reference:
* [Observable Demo](https://github.com/observatorium/observable-demo)
* [Slides](https://github.com/kakkoyun/are-you-testing-your-observability)
* [Thanos](https://thanos.io)
* [Prometheus](https://prometheus.io)
